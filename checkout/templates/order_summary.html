{% extends 'base.html' %}
{% load static %}
{% block main %}
<link rel="stylesheet" href="{% static 'css/order_summary.css' %}" />
<div class="container">
    <!-- Seção de Resumo do Pedido -->
    <!-- Passos -->
    <div class="checkout-steps">
        <div class="step active">
            <img src="{% static 'images/Location.svg' %}" alt="Localização" id="location-icon" />
            <div class="step-info">
                <span class="step-number">Step 1</span>
                <span class="step-name">Address</span>
            </div>
        </div>
        <div class="step">
            <img src="{% static 'images/Shipping.svg' %}" alt="Shipping" id="Shipping-icon" />
            <div class="step-info">
                <span class="step-number">Step 2</span>
                <span class="step-name">Shipping</span>
            </div>
        </div>
        <div class="step">
            <img src="{% static 'images/Payment.svg' %}" alt="Payment" id="paymentg-icon" />
            <div class="step-info">
                <span class="step-number">Step 3</span>
                <span class="step-name">Payment</span>
            </div>
        </div>
    </div>
    <div class="order-summary-header">
        <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="order-item">
                {% if itens_carrinho %}
                {% for item in itens_carrinho %}
                <div class="item">
                    {% if item.produto.imagem %}
                    <img src="{{ item.produto.imagem.url }}" alt="{{ item.produto.nome }}" />
                    {% else %}
                    <img src="{% static 'images/default.png' %}" alt="Imagem não disponível" />
                    {% endif %}
                    <div class="item-details">
                        <span class="product-name">{{ item.produto.nome }}</span>
                        {% if item.size %}
                        <span class="size">{{ item.size|upper }} X {{ item.quantidade }}</span>
                        {% endif %}
                    </div>
                    <span class="price">R$ {{ item.subtotal|floatformat:2 }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="address">
                <h3>Address</h3>
                {% if endereco %}
                    {% if endereco.complemento %}
                    <p>{{ endereco.nome_completo }}</p>
                    <p>{{ endereco.rua }}, {{ endereco.numero }}, {{ endereco.bairro }} - {{ endereco.cidade }}/{{endereco.get_estado_display }}</p>
                    <p>CEP: {{ endereco.cep }} | Complemento: {{ endereco.complemento }}</p>
                    <p>Telefone: {{ endereco.telefone }}</p>
                    {% endif %}
                {% else %}
                <p>Nenhum endereço cadastrado</p>
                {% endif %}
            </div>
            <div class="shipping">
                <h3>Shipment method</h3>
                {% if frete_escolhido %}
                <div class="shipping-details">
                    <p>{{ frete_escolhido.company.name }}:</p>
                    <span>{{ frete_escolhido.name }}</span>
                </div>
                <div class="shipping-details">
                    <p>Prazo:</p>
                    <span>{{ frete_escolhido.delivery_time }} dias úteis</span>
                </div>
                <div class="shipping-details">
                    <p>Valor:</p>
                    <span class="price">R$ {{ frete|floatformat:2 }}</span>
                </div>
                {% endif %}
            </div>
            <div class="totals">
                <div class="total-row">
                    <span>Subtotal</span>
                    <span class="price">R$ {{ subtotal|floatformat:2 }}</span>
                </div>
                <div class="total-row grand-total">
                    <span>TOTAL</span>
                    <span class="price">R$ {{ total|floatformat:2 }}</span>
                </div>
            </div>
            {% else %}
            <p class="empty-cart">Seu carrinho está vazio.</p>
            {% endif %}
        </div>
        <div class="payment">
            <h2>Pagamento</h2>
            <!-- O Payment Element será montado aqui -->
            <form id="payment-form">
                <div id="payment-element">
                    <!--Stripe.js insere o Payment Element aqui-->
                </div>
                <button id="submit" class="stripe-form-btn">
                    <div class="spinner hidden" id="spinner"></div>
                    <span id="button-text">Pagar R$ {{ total|floatformat:2 }}</span>
                </button>
                <div id="payment-message" class="hidden"></div>
            </form>
            <div class="stripe-form-note">
                Pagamentos seguros via Stripe. Aceitamos os principais cartões.
            </div>
        </div>
        <script src="https://js.stripe.com/v3/"></script>
        <script>
            document.addEventListener("DOMContentLoaded", async () => {
                const stripe = Stripe("{{ stripe_public_key }}");

                let elements;

                // --- Definição da Aparência ---
                const appearance = {
                    theme: 'stripe',
                    variables: {
                        colorPrimary: '#0570de',
                        colorBackground: '#ffffff',
                        colorText: '#30313d',
                        colorDanger: '#df1b41',
                        fontFamily: 'Ideal Sans, system-ui, sans-serif',
                        spacingUnit: '4px',
                        borderRadius: '4px',
                        colorTextPlaceholder: '#9a9a9a',
                        colorIcon: '#6b7280',
                    },
                    rules: {
                        '.Input': {
                            border: '1px solid #d1d1d1',
                            boxShadow: 'none',
                        },
                        '.Input:focus': {
                             borderColor: '#0570de',
                             boxShadow: 'none',
                        },
                        '.Input--invalid': {
                            borderColor: '#df1b41',
                        },
                        '.Tab': {
                            border: '1px solid #d1d1d1',
                        },
                        '.Tab--selected': {
                            borderColor: '#0570de',
                        }
                    }
                };
                // --- Fim da Definição da Aparência ---

                initialize();

                document
                    .querySelector("#payment-form")
                    .addEventListener("submit", handleSubmit);

                async function initialize() {
                    const response = await fetch("{% url 'checkout:stripe_create_payment_intent' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                        },
                    });
                    const { clientSecret, error } = await response.json();

                    if (error) {
                        showMessage(error);
                        setLoading(false);
                        return;
                    }
                    if (!clientSecret) {
                         showMessage("Erro: clientSecret não recebido do servidor.");
                         setLoading(false);
                         return;
                    }

                    elements = stripe.elements({ appearance, clientSecret });

                    const paymentElementOptions = {
                        layout: "tabs",
                    };

                    const paymentElement = elements.create("payment", paymentElementOptions);
                    paymentElement.mount("#payment-element");
                    setLoading(false);
                }

                async function handleSubmit(e) {
                    e.preventDefault();
                    setLoading(true);

                    const { error } = await stripe.confirmPayment({
                        elements,
                        confirmParams: {
                            return_url: "{{ request.scheme }}://{{ request.get_host }}{% url 'checkout:thanks' %}",
                        },
                    });

                    if (error) {
                         if (error.type === "card_error" || error.type === "validation_error") {
                            showMessage(error.message);
                        } else {
                            showMessage("Ocorreu um erro inesperado.");
                        }
                    }

                    setLoading(false);
                }

                function showMessage(messageText) {
                    const messageContainer = document.querySelector("#payment-message");
                    messageContainer.classList.remove("hidden");
                    messageContainer.textContent = messageText;

                    setTimeout(function () {
                        messageContainer.classList.add("hidden");
                        messageContainer.textContent = "";
                    }, 4000);
                }

                function setLoading(isLoading) {
                    const submitButton = document.querySelector("#submit");
                    const spinner = document.querySelector("#spinner");
                    const buttonText = document.querySelector("#button-text");

                    submitButton.disabled = isLoading;
                    spinner.classList.toggle("hidden", !isLoading);
                    buttonText.classList.toggle("hidden", isLoading);
                }
            });
        </script>
    </div>
</div>
{% endblock %}
