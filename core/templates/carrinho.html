{% extends 'base.html' %}
{% load static %}
{% load atributos_extras %}

{% block main %}
<link rel="stylesheet" href="{% static 'css/carrinho.css' %}">
<script src="{% static 'js/remove.js' %}"></script>
<script src="{% static 'js/frete.js' %}"></script>
<script src="{% static 'js/cart_quantity.js' %}"></script>

<div class="cart-container">
    <div class="breadcrumb">
        <a href="{% url 'index' %}">Home</a> > 
        <span>Cart</span>
    </div>

    <h1 class="cart-title">Your cart</h1>

    <div class="cart-content">
        <div class="cart-items">
            {% if itens_carrinho %}
                {% for item in itens_carrinho %}
                    <div class="cart-item">
                        <div class="item-image">
                            {% if item.produto.imagem %}
                                <img src="{{ item.produto.imagem.url }}" alt="{{ item.produto.nome }}">
                            {% else %}
                                <img src="{% static 'images/default.png' %}" alt="Imagem não disponível">
                            {% endif %}
                        </div>
                        <div class="item-details">
                            <div class="item-info">
                                <h3 class="item-name">{{ item.produto.nome }}</h3>                                {# Nova estrutura: mostra apenas atributos principais da variação #}
                                {% if item.variacao %}
                                    {% for atributo in item.variacao.atributos.all|get_atributos_principais %}
                                        <p class="item-attribute">{{ atributo.tipo.nome }}: {{ atributo.valor }}</p>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="item-price-info">
                                <p class="item-price">Preço Unitário: R$ {{ item.produto.preco }}</p>
                                <p class="item-subtotal">Subtotal: R$ {{ item.subtotal }}</p>
                            </div>
                        </div>
                        <div class="action-center">
                            {# Sempre mostra os botões, mas se item.chave_id não existir, desabilita/remover funcionalidade #}
                            <form action="{% if item.chave_id %}{% url 'remover-item' item.chave_id %}{% else %}#{% endif %}" method="post" class="remover-form">
                                {% csrf_token %}
                                <button type="submit" class="remove-btn item-remove" {% if not item.chave_id %}disabled title="Ação não disponível para este item"{% endif %}>
                                    <img src="{% static 'images/delete.svg' %}" alt="delete">
                                </button>
                            </form>
                            <div class="quantity-control">
                                <form action="{% if item.chave_id %}{% url 'diminuir-item' item.chave_id %}{% else %}#{% endif %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="quantity-decrease" {% if not item.chave_id %}disabled title="Ação não disponível para este item"{% endif %}>-</button>
                                </form>
                                <span>{{ item.quantidade }}</span>
                                <form action="{% if item.chave_id %}{% url 'aumentar-item' item.chave_id %}{% else %}#{% endif %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="quantity-increase" {% if not item.chave_id %}disabled title="Ação não disponível para este item"{% endif %}>+</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% if not forloop.last %}<hr class="item-divider">{% endif %}
                {% endfor %}
            {% else %}
                <p id="carrinho-vazio">Seu carrinho está vazio.</p>
            {% endif %}
        </div>

        <div class="order-summary">
            <h3 class="summary-title">Resumo do Pedido</h3>
            <form method="post" style="margin-bottom: 10px;">
                {% csrf_token %}
                <input type="text" name="cupom" placeholder="Cupom de desconto" value="{{ cupom.codigo|default_if_none:'' }}">
                <button type="submit" class="checkout-btn" style="margin-bottom: 8px;">Aplicar Cupom</button>
                {% if cupom %}
                    <button type="submit" name="remover_cupom" value="1" class="checkout-btn" style="background:#ccc; color:#222; margin-left:8px;">Remover Cupom</button>
                {% endif %}
            </form>
            <div class="summary-row">
                <span>Subtotal</span>
                <span>R$ {{ total_carrinho }}</span>
            </div>
            {% if desconto and desconto > 0 %}
            <div class="summary-row discount">
                <span>Desconto</span>
                <span>-R$ {{ desconto|floatformat:2 }}</span>
            </div>
            {% endif %}
            <div class="summary-row">
                <span>Taxa de Entrega</span>
                <span id="frete-valor">
                    {% if user.is_authenticated and cep_usuario %}
                        <span id="frete-valor-span">Calculando...</span>
                    {% else %}
                        <span id="frete-valor-span">R$ --</span>
                    {% endif %}
                </span>
            </div>
            <div class="summary-total">
                <span>Total</span>
                <span id="total-com-frete">R$ {{ total_carrinho_com_cupom|default:total_carrinho|floatformat:2 }}</span>
            </div>
            <form method="get" action="{% url 'checkout:select_address' %}">
                <button type="submit" class="checkout-btn">Finalizar Pedido</button>
            </form>
            <div class="frete-box" style="margin-top: 24px; padding: 16px; border: 1px solid #eee; border-radius: 10px;">
                <label for="cep-frete"><strong>Calcule o Frete</strong></label>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <input type="text" id="cep-frete" maxlength="9" placeholder="Digite o CEP" style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;"
                        value="{% if user.is_authenticated and cep_usuario %}{{ cep_usuario }}{% endif %}">
                    <button type="button" id="btn-calcular-frete" style="padding:8px 18px; border-radius:6px; background:#1976d2; color:#fff; border:none; cursor:pointer;">Calcular</button>
                </div>
                <div id="frete-status" style="margin-top:8px; color:#1976d2; font-size:0.95rem;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}